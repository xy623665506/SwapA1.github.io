<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SwapA1.app</title>
  <meta name="description" content="Generate Bambu A1 SWAP queue files">
  <meta name="keywords" content="Bambulab A1 mini, 3MF, swapmod, 3d print queue">
  <meta name="author" content="Andre Bar">
  <link rel="icon" type="image/png" href="./SwapA1.app_files/logo_app.png">
  <script src="./SwapA1.app_files/jszip_m.js"></script>
  <script src="./SwapA1.app_files/spark-md5.min.js"></script>
  <style>
    :root {
      --ci_1:#00BBDC;
      --ci_2:#00eeff;
    }
    body {
      font-family:'Noto Sans','Arial',sans-serif;
      font-size:14px;
      margin:0;
      background-color:#fff;
      color:#222;
    }
    #app_wrapper{max-width:1110px;margin:0 auto;padding:10px 20px;}
    #logo{height:42px;}
    #export{
      background-color:#EDF07A;
      border:#555 2px solid;
      border-radius:5px;
      width:170px;height:60px;
      font-weight:600;cursor:pointer;margin-top:25px;
    }
    #export:hover{background-color:#fdffbf;}
    #reset{
      background-color:#555;color:#EDF07A;
      border:#555 2px solid;border-radius:5px;
      width:170px;height:30px;font-weight:600;cursor:pointer;
    }
    #drop_zone,#drop_zone_instant{
      border:3px dashed #9DB0CC;
      border-radius:10px;
      padding:10px;
      text-align:center;
      color:#9DB0CC;
    }
    #drop_zone p{font-size:20pt;font-weight:700;margin:10px 0;}
    #drop_zone_instant p{font-size:16pt;}
    .hidden{display:none;}
    #progress_bar{background:#eee;width:100px;height:5px;border:1px solid #ccc;margin-top:10px;}
    #progress_scale{height:100%;background:linear-gradient(90deg,var(--ci_1),var(--ci_2));width:0;}
    #playlist_ol{padding:0;list-style:none;}
    .list_item{width:200px;height:380px;border:1px solid #999;border-radius:8px;padding:5px;margin:5px;display:inline-block;vertical-align:top;}
    .p_icon{width:190px;height:190px;border-radius:4px;background:#eee;object-fit:cover;}
    .p_info{padding:5px;}
    .p_time{font-size:14pt;color:#777;}
    .p_rep{width:55px;height:25px;border-radius:4px;font-size:14pt;text-align:center;}
  </style>
</head>

<body>
  <div id="app_wrapper">
    <div id="app_header">
      <img id="logo" src="./SwapA1.app_files/logo_app.png" alt="SwapA1 Logo">
      <p style="margin-top:0;font-size:10pt;">Powered by swaplist.app – Licensed from Swap-Systems</p>
      <div id="statistics" class="hidden">
        <div id="queue_statistics">
          <h3>Queue statistics:</h3>
          <div><span>Duration:</span> <span id="total_time">0s</span></div>
          <div><span>Plates:</span> <span id="used_plates">0</span></div>
        </div>
      </div>
      <div id="action_buttons" class="hidden">
        <button id="reset" onclick="location.reload()">Reset</button>
        <button id="export" onclick="export_3mf()">Generate SWAP file</button>
        <div id="progress_bar"><div id="progress_scale"></div></div>
      </div>
      <div id="show_set_cont">
        <input type="checkbox" id="show_settings" onchange="toggle_settings(this.checked)">
        <label for="show_settings">Show settings</label>
      </div>
    </div>

    <div id="drop_zones_wrapper">
      <div id="drop_zone">
        <p>DROP YOUR FILE(S) HERE</p>
        <i>...or click to select</i>
      </div>
      <div id="drop_zone_instant">
        <p>DROP HERE FOR <br><i>EXPRESS CONVERSION</i></p>
      </div>
    </div>

    <input type="file" id="file" class="hidden" accept=".3mf,.gcode" multiple>

    <ol id="playlist_ol"></ol>

    <p id="version" style="color:#999;">V00-25</p>
    <p style="color:#aaa;font-size:10pt;">Runs locally in your browser. No data is uploaded.</p>
  </div>

  <script>
    // 加载 obfsc.js（本地路径）
    const scriptUrl = "./SwapA1.app_files/obfsc.js";
    async function loadObfs() {
      try {
        const res = await fetch(scriptUrl, {cache:'no-store'});
        if (!res.ok) throw new Error('HTTP '+res.status);
        const code = await res.text();
        const blob = new Blob([code], {type:'application/javascript'});
        const blobUrl = URL.createObjectURL(blob);
        await new Promise((resolve,reject)=>{
          const s=document.createElement('script');
          s.src=blobUrl;
          s.onload=()=>{URL.revokeObjectURL(blobUrl);resolve();};
          s.onerror=(e)=>{URL.revokeObjectURL(blobUrl);reject(e);};
          document.head.appendChild(s);
        });
        console.log("✅ obfsc.js loaded.");
      } catch(err){
        console.error("❌ Failed to load obfsc.js:", err);
      }
    }
    loadObfs();

    let my_files=[];
    let fileInput=document.getElementById("file");
    let playlist_ol=document.getElementById("playlist_ol");
    let p_scale=document.getElementById("progress_scale");
    let instant_processing=false;
    let last_file=false;

    window.addEventListener("DOMContentLoaded",()=>{
      const drop_zone=document.getElementById("drop_zone");
      const drop_zone_instant=document.getElementById("drop_zone_instant");

      drop_zone.addEventListener("click",()=>{fileInput.click();instant_processing=false;});
      drop_zone_instant.addEventListener("click",()=>{fileInput.click();instant_processing=true;});

      fileInput.addEventListener("change",(evt)=>{
        const files=evt.target.files;
        for(let i=0;i<files.length;i++){
          last_file=(i+1===files.length);
          handleFile(files[i]);
        }
      });
    });

    function toggle_settings(state){
      alert("Settings panel not implemented in this simplified version.");
    }

    function update_progress(i){
      if(i<0){p_scale.style.width="0%";return;}
      p_scale.style.width=i+"%";
    }

    function handleFile(f){
      // 这里只演示载入逻辑；完整逻辑在 obfsc.js 中实现
      console.log("Loaded file:", f.name);
      document.getElementById("action_buttons").classList.remove("hidden");
      let li=document.createElement("li");
      li.className="list_item";
      li.innerHTML=`<div class="p_title">${f.name}</div>
        <img class="p_icon" src="./SwapA1.app_files/logo_app.png">
        <div class="p_info"><span class="p_time">ready</span>
        <input class="p_rep" type="number" value="1"></div>`;
      playlist_ol.appendChild(li);
    }

    async function export_3mf(){
      alert("Generate SWAP file function loaded. (Real logic inside obfsc.js)");
      // obfsc.js 会注入 export_3mf 的完整实现
    }
  </script>
</body>
</html>
